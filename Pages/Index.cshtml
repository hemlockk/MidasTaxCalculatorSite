@page
@model MidasTaxCalculatorSite.Pages.IndexModel


<script>
    $(function () {
        $("form[asp-page-handler='SaveKeys']").removeData("validator") 
                                              .removeData("unobtrusiveValidation");
    });
     function toggleExample() {
            const box = document.getElementById("exampleBox");
            const btn = event.target;

            if (box.style.maxHeight === "0px" || box.style.maxHeight === "") {
            box.style.maxHeight = box.scrollHeight + "px";
            box.style.opacity = "1";
            btn.innerText = "Gizle";
            } else {
            box.style.maxHeight = "0";
            box.style.opacity = "0";
            btn.innerText = "Göster";
            }
        }
</script>
<script src="~/js/site.js" asp-append-version="true"></script>
<body style="
  min-height:100vh;
  background-image:url('/images/background.png');
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:3rem 1.5rem;
">
    <header>
        <div style="
        width:100%;
        max-width:1400px;
        margin-bottom:1.8rem;
        background:white;
        padding:1.2rem 2rem;
        border-radius:16px;
        box-shadow:0 10px 28px rgba(0,0,0,0.18);
        display:flex;
        align-items:center;
        justify-content:space-between;
        ">

        <!-- LEFT: Logo + Title -->
        <div style="display:flex; align-items:center; gap:0.9rem;">
            <img src="/images/logo.jpg"
                alt="Logo"
                style="
                height:60px;
                width:60px;
                object-fit:contain;
                border-radius:8px;
                " />

            <div>
            <div style="
                font-size:1.15rem;
                font-weight:700;
                color:#0f172a;
                line-height:1.2;
            ">
                ABD Borsası Vergi Hesaplama
            </div>
            <div style="
                font-size:0.8rem;
                color:#6b7280;
            ">
                ABD Hisseleri · Türk Vergi Mevzuatı
            </div>
            </div>
        </div>

        <!-- RIGHT: Beta + Dark Mode -->
        <div style="
            display:flex;
            align-items:center;
            gap:0.6rem;
        ">

            <div style="
                font-size:0.75rem;
                padding:0.35rem 0.7rem;
                border-radius:999px;
                background:#eef2ff;
                color:#4338ca;
                font-weight:600;
            ">
                Beta
            </div>

            <button id="darkModeToggle" type="button">
                🌙
            </button>

        </div>


        </div>
    </header>
<div style="
    background:white;
    width:100%;
    max-width:1400px;
    padding:3rem 3.5rem;
    border-radius:18px;
    box-shadow:0 20px 45px rgba(0,0,0,0.25);
  ">
    <div style="margin-bottom:15px; font-size:15px; line-height:1.5;">
        <p>
            Bu uygulamanın amacı henüz daha satmamış olduğunuz ABD borsası hisselerinizin size vergi sonrası gerçek getirisini görmenize yardımcı olmaktır.
        </p>
        <p>
            ABD borsalarından elde edilen alım satım kazançları, beyana tabi tutulmalıdır.
            Bu kazançlar Türk Lirası cinsinden hesaplanmalıdır. Dolar/TL dönüşümlerinde,
            işlem gününden bir önceki günün Türkiye Cumhuriyeti Merkez Bankası kapanış kuru temel alınmalıdır.
            Alım satım kazancının hesaplanması sırasında endeksleme yöntemini kullanabilmek için
            Yİ-ÜFE farkının %10 üzerinde olması gerekmektedir. İşlem tarihlerinin bir ay önceki ÜFE endeksi baz alınarak
            alım fiyatı endekslenir.
        </p>
            <div style="margin-bottom:2.5rem;">

        <div style="
        display:flex;
        align-items:center;
        gap:0.75rem;
        margin-bottom:1rem;
        ">
        <h3 style="
            font-size:1.2rem;
            font-weight:700;
            margin:0;
            color:#0f172a;
        ">
            📌 Örnek Hesaplama
        </h3>

        <button
            type="button"
            onclick="toggleExample()"
            style="
            font-size:0.8rem;
            padding:0.3rem 0.7rem;
            border-radius:999px;
            border:1px solid #d1d5db;
            background:#f9fafb;
            cursor:pointer;
            line-height:1;
            "
        >
            Göster
        </button>
        </div>
        <div id="exampleBox" style="
        overflow:hidden;
        max-height:0;
        opacity:0;
        transition:max-height 0.35s ease, opacity 0.25s ease;
        ">
            <div class="example" style="
                background:#f9fafb;
                border:1px solid #e5e7eb;
                border-radius:12px;
                padding:1.25rem 1.5rem;
                margin-bottom:1.2rem;
            ">
                <strong>İşlem Bilgileri</strong>
                <ul style="margin-top:0.6rem; padding-left:1.2rem;">
                <li><strong>Alış Tarihi:</strong> 20 Eylül 2023</li>
                <li><strong>Satış Tarihi:</strong> 19 Aralık 2025</li>
                </ul>
            </div>

            <div class="example" style="
                background:#f9fafb;
                border:1px solid #e5e7eb;
                border-radius:12px;
                padding:1.25rem 1.5rem;
                margin-bottom:1.2rem;
            ">
                <strong>Yİ-ÜFE Endeks Bilgileri</strong>
                <ul style="margin-top:0.6rem; padding-left:1.2rem;">
                <li><strong>Ağustos 2023 ÜFE Endeksi:</strong> 2.659,60</li>
                <li><strong>Kasım 2025 ÜFE Endeksi:</strong> 4.747,63</li>
                <li><strong>ÜFE Farkı:</strong> %78,51</li>
                </ul>
            </div>

            <div class="example" style="
                background:#f9fafb;
                border:1px solid #e5e7eb;
                border-radius:12px;
                padding:1.25rem 1.5rem;
                margin-bottom:1.2rem;
            ">
                <strong>TCMB Döviz Kurları (USD/TRY)</strong>
                <ul style="margin-top:0.6rem; padding-left:1.2rem;">
                <li><strong>19 Eylül 2023 kapanış Kuru:</strong> 27,0300</li>
                <li><strong>18 Aralık 2025 kapanış Kuru:</strong> 42,7285</li>
                </ul>
            </div>

            <p style="margin-bottom:0.8rem;">
                Yİ-ÜFE farkı <strong>%10’un üzerinde</strong> olduğu için,
                <strong>endeksleme yöntemi uygulanabilir</strong>.
                Bu durumda alış bedeli, alış tarihine ait ÜFE endeksi dikkate alınarak güncellenir.
            </p>

            <p style="margin-bottom:0.8rem;">
                ABD borsalarında yapılan işlemlerden elde edilen kazançlar,
                Türk Lirası cinsinden hesaplanmak zorundadır.
                Bu nedenle alış ve satış tutarları, ilgili tarihlerdeki
                <strong>TCMB USD/TRY kapanış kurları</strong> kullanılarak TL’ye çevrilir.
            </p>

            <p>
                Son olarak, <strong>endekslenmiş alış bedeli</strong> ile
                <strong>satış bedeli</strong> arasındaki fark,
                vergilendirilebilir kazancı oluşturur.
            </p>
            </div>
        </div>
        <p>
            Uygulamanın kullanımı için hisse kodunuzu, hisseyi aldığınız tarihi, alınan hisse miktarını ve hisseyi aldığınız tarihteki dolar bazlı fiyatını girmeniz yeterlidir.
            İstenilen bilgiler eklendikten sonra "Vergiyi Hesapla" butonuna tıklayarak vergi hesaplamasını gerçekleştirebilirsiniz. Vergi hesaplamanızda hissenin güncel fiyatı baz alınacaktır.
            Belirtlen bilgilere Midas uygulamasındali İşlem Geçmişi sekmesinden ulaşabilirsiniz.  
        </p>
        <p>Örnek İşlem Geçmişi ekran görüntüsü:</p>

        <button class="btn btn-secondary mb-2" type="button"
                data-bs-toggle="collapse" data-bs-target="#exampleImages">
            Görselleri Göster / Gizle
        </button>

        <div class="collapse" id="exampleImages">
            <div class="text-left my-4 d-flex gap-3">
                <img src="~/images/MidasStockCode.jpg"
                    alt="Midas Stock Code"
                    class="img-fluid"
                    style="max-width: 250px;">

                <img src="~/images/MidasInfo.jpg"
                    alt="Midas Info"
                    class="img-fluid"
                    style="max-width: 250px;">
            </div>
        </div>


        <p style="color:red; font-weight:bold;">
            ÖNEMLİ UYARI: Bu uygulama sadece kendi hesaplamanızı karşılaştırmak amacıyla hazırlanmıştır.
            Hesaplanan değerlerin doğruluğu garanti edilmemektedir.
        </p>
    </div>

    <script>
        function validateWeekend() {
            const dateValue = document.getElementById('buyDate').value;
            if (!dateValue) return true; // allow empty check to server

            const date = new Date(dateValue + "T00:00:00"); 
            const day = date.getDay(); // Local day: 0=Sunday, 6=Saturday

            if (day === 0 || day === 6) {
                alert("Buy Date cannot be a weekend day!");
                return false; // Block form submit
            }

            return true; // allow submit
        }
    </script>

    <h2>Hisse Ekle</h2>

    <form method="post" asp-page-handler="AddStock" class="mt-3">

        <div class="row g-3">

            <div class="col-md-3">
                <label class="form-label">Hisse Kodu</label>
                <input asp-for="UserInput.StockCode"
                    class="form-control"
                    maxlength="5"
                    required
                    pattern="[A-Za-z\.]{1,5}" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Satın Alım Tarihi</label>
                <input type="date" value="@DateTime.Today.AddDays(-1).ToString("yyyy-MM-dd")"
                    asp-for="UserInput.BuyDate"
                    class="form-control"
                    id="buyDate"
                    required />
            </div>

            <div class="col-md-3">
                <label class="form-label">Hisse Miktarı</label>
                <input asp-for="UserInput.BuyAmount"
                    type="number"
                    class="form-control"
                    step="0.01"
                    required
                        />
            </div>

            <div class="col-md-3">
                <label class="form-label">Alım Fiyatı ($)</label>
                <input asp-for="UserInput.BuyPrice"
                    type="number"
                    step="0.01"
                    class="form-control"
                    required />
            </div>

        </div>

        <!-- Validation messages displayed here instead -->
        <div class="row">
            <div class="col-md-12 mt-1">
                <span asp-validation-for="UserInput.StockCode" class="text-danger d-block"></span>
                <span asp-validation-for="UserInput.BuyDate" class="text-danger d-block"></span>
                <span asp-validation-for="UserInput.BuyAmount" class="text-danger d-block"></span>
                <span asp-validation-for="UserInput.BuyPrice" class="text-danger d-block"></span>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-2">Hisse Ekle</button>

    </form>

        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                Eklenen Hisseler
            </div>

            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th>Hisse</th>
                            <th>Alış Fiyatı ($)</th>
                            <th>Alış Tarihi</th>
                            <th>Adet</th>
                            <th>Sil</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.CreatedStocks.Count; i++)
                        {
                            <tr>
                                <td>@Model.CreatedStocks[i].StockCode</td>
                                <td>@Model.CreatedStocks[i].BuyPrice.ToString("N2")</td>
                                <td>@Model.CreatedStocks[i].BuyDate.ToString("dd.MM.yyyy")</td>
                                <td>@Model.CreatedStocks[i].BuyAmount</td>
                                <td>
                                    <form method="post" asp-page-handler="DeleteStock" style="display:inline;">
                                        <input type="hidden" name="index" value="@i" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            🗑
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="card-footer d-flex gap-3">
                <form method="post" asp-page-handler="CalculateTax" class="me-2">
                    <button type="submit" class="btn btn-success btn-sm">Vergiyi Hesapla</button>
                    @for (int i = 0; i < Model.CreatedStocks.Count; i++) 
                    { 
                        <input type="hidden" asp-for="CreatedStocks[i].StockCode" /> 
                        <input type="hidden" asp-for="CreatedStocks[i].BuyDate" /> 
                        <input type="hidden" asp-for="CreatedStocks[i].BuyAmount" /> 
                        <input type="hidden" asp-for="CreatedStocks[i].BuyPrice" /> 
                        <input type="hidden" asp-for="CreatedStocks[i].CurrentPrice" /> 
                    }
                </form>

                <form method="post" asp-page-handler="Clear">
                    <button type="submit" class="btn btn-danger btn-sm">Tümünü Temizle</button>
                </form>
            </div>
        </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger mt-3">
           ❌ @Model.ErrorMessage
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.WarningMessage))
    {
        <div class="warning alert-warning mt-3">
           ⚠️ @Model.WarningMessage
        </div>
    }
    @if (Model.TaxCalculated)
    {
        <h3 class="mt-4 mb-3">Vergi Hesaplama Sonucu</h3>

        <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-dark">
                <tr>
                    <th>Hisse</th>
                    <th>Alış Tarihi</th>
                    <th>Pay Adedi</th>
                    <th>Kar (TL)</th>
                    <th>Min. Vergi (15%)</th>
                    <th>Detay</th>
                </tr>
            </thead>

            <tbody>
                @for (int i = 0; i < Model.CreatedStocks.Count; i++)
                {

                    var s = Model.CreatedStocks[i];
                    var detailId = $"details-{i}";
                    @if (s.CurrentPrice == -1)
                    {
                    <tr>
                        <td colspan="6" class="text-start">@s.StockCode hisse için anlık fiyat bulunamadı lütfen hisse kodunu kontrol ediniz.</td>
                    </tr>
                        continue;
                    }
                    <tr>
                        <td>@s.StockCode</td>
                        <td>@s.BuyDate.ToString("dd.MM.yyyy")</td>
                        <td>@s.BuyAmount</td>
                        <td>@s.Profit.ToString("N2") TL</td>
                        <td>@s.MinTaxRateApplied.ToString("N2") TL</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@detailId">
                                Detay
                            </button>
                        </td>
                    </tr>

                    <!-- Details row -->
                    <tr class="collapse bg-light" id="@detailId">
                        <td colspan="6" class="text-start">
                            <div class="p-3">
                                <strong>Detaylı Hesaplama</strong>
                                @{
                                    var inflationFactorPercent =
                                        s.BuyUfeIndex > 0
                                            ? (s.SellUfeIndex / s.BuyUfeIndex - 1) * 100
                                            : 0;
                                }
                                <ul class="mb-0 mt-2">
                                    <li><strong>Anlık Fiyat ($):</strong> @s.CurrentPrice.ToString("N4")</li>
                                    <li><strong>Alış (@s.BuyUfeDate) ÜFE Endeksi:</strong> @s.BuyUfeIndex.ToString("N2")</li>
                                    <li><strong>Satış (@s.SellUfeDate) ÜFE Endeksi:</strong> @s.SellUfeIndex.ToString("N2")</li>
                                    <li>
                                        <strong>ÜFE Farkı:</strong>
                                        @inflationFactorPercent.ToString("N2") %
                                    </li>
                                    <li><strong>Alış Kur (USD/TRY):</strong> @s.BuyRate.ToString("N4")</li>
                                    <li><strong>Satış Kur (USD/TRY):</strong> @s.SellRate.ToString("N4")</li>
                                </ul>
                                @if (s.Splits != null && s.Splits.Count > 0)
                                {
                                    <div class="alert alert-info mt-3">
                                        <strong>Aldığınız hisse aşağıdaki tarihlerde bölünmüştür:</strong>

                                        <ul class="mt-2 mb-0">
                                            @foreach (var split in s.Splits
                                                .OrderBy(s => s.EffectiveDate))
                                            {
                                                <li>
                                                    @split.EffectiveDate.ToString("dd.MM.yyyy")
                                                    |
                                                    @($"{split.SplitFactor}:1")
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>

        <tfoot class="table-secondary fw-bold text-center">
                <tr>
                    <td colspan="2">
                        Brüt Gelir<br />
                        <span class="@(Model.TotalProfit >= 0 ? "text-success" : "text-danger")">
                            @Model.TotalProfit.ToString("N2") TL
                        </span>
                    </td>

                    <td colspan="2">
                        Toplam Vergi<br />
                        <span class="text-danger">
                            @Model.TotalTax.ToString("N2") TL
                        </span>
                    </td>

                    <td colspan="2">
                        Vergi Sonrası Net Gelir<br />
                        @{
                            var netIncome = Model.TotalProfit - Model.TotalTax;
                        }
                        <span class="@(netIncome >= 0 ? "text-success" : "text-danger")">
                            @netIncome.ToString("N2") TL
                        </span>
                    </td>
                </tr>
            </tfoot>
        </table>
    }

    <div class="card mt-4 mb-4">
        <div class="card-header bg-info text-white">
            API Anahtarlarınız
        </div>

        <div class="card-body">

            <div class="alert alert-warning small" role="alert">
                EVDS ve Yahoo API anahtarlarının girilmesi gerekir.
                API anahtarlarınızınasıl elde edeceğinize dair aşağıdaki bölümleri inceleyebilirsiniz.Bu anahtarlar ücretsizdir sadece kullanım limitleri vardır.
            </div>

            <form method="post" asp-page-handler="SaveKeys" novalidate data-val="false">
                <div class="row g-3">
                    <div class="col-md-4 position-relative">
                        <label class="form-label">EVDS API Key</label>
                        <input asp-for="UserEvdsKey"
                            class="form-control"
                            placeholder="Varsayılan anahtar kullanılacak">
                        @if (Model.HasUserEvdsKey)
                        {
                            <span class="text-success position-absolute top-50 end-0 translate-middle-y me-2">✔</span>
                        }
                    </div>
                    <div class="col-md-4 position-relative">
                        <label class="form-label">Yahoo API Key</label>
                        <input asp-for="UserYahooKey"
                            class="form-control"
                            placeholder="Varsayılan anahtar kullanılacak">
                        @if (Model.HasUserYahooKey)
                        {
                            <span class="text-success position-absolute top-50 end-0 translate-middle-y me-2">✔</span>
                        }
                    </div>
                </div>
                <button type="submit" class="btn btn-info text-white mt-3">
                    Anahtarları Kaydet
                </button>
            </form>
            <div class="accordion mt-3" id="apiHelpAccordion">

            <!-- EVDS -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingEvds">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseEvds">
                        EVDS API Anahtarı Nasıl Alınır?
                    </button>
                </h2>
                <div id="collapseEvds"
                    class="accordion-collapse collapse"
                    data-bs-parent="#apiHelpAccordion">
                    <div class="accordion-body small">

                        <strong>EVDS Kayıt Olma ve API Abonesi Olma</strong>
                        <ol class="mt-2">
                            <li>
                                TCMB EVDS sistemine aşağıdaki bağlantıdan gidin:
                                <br />
                                <a href="https://evds2.tcmb.gov.tr/index.php?/evds/login"
                                target="_blank">
                                    https://evds2.tcmb.gov.tr/index.php?/evds/login
                                </a>
                            </li>
                            <li>
                                “GİRİŞ YAP” butonu altında yer alan
                                <strong>“KAYIT OL”</strong> seçeneği ile kayıt olun.
                            </li>
                            <li>
                                Giriş yaptıktan sonra profil sayfanıza gidin:
                                <br />
                                <a href="https://evds2.tcmb.gov.tr/index.php?/evds/editProfile"
                                target="_blank">
                                    Profil Sayfası
                                </a>
                            </li>
                            <li>
                                Sayfanın alt kısmında yer alan
                                <strong>“API ANAHTARI”</strong> butonuna basın.
                            </li>
                            <li>
                                Oluşturulan API anahtarını kopyalayarak buraya yapıştırın.
                            </li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Yahoo -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingYahooVantage">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseYahooVantage">
                        Yahoo API Anahtarı Nasıl Alınır?
                    </button>
                </h2>
                <div id="collapseYahooVantage"
                    class="accordion-collapse collapse"
                    data-bs-parent="#apiHelpAccordion">
                    <div class="accordion-body small">

                        <strong>Yahoo API Key Oluşturma</strong>
                        <ol class="mt-2">
                            <li>
                                Yahoo API sitesine gidin:
                                <br />
                                <a href="https://www.alphavantage.co/support/#api-key"
                                target="_blank">
                                    https://www.alphavantage.co/support/#api-key
                                </a>
                            </li>
                            <li>
                                Claim your Free API Key sekmesinin hemen altında email adresinizi girin. Diğer kısımları da kendinize göre doldurabilirsiniz.
                            </li>
                            <li>
                                GET FREE API KEY butonuna tıkladıkran sonra API key'inizi hemen alta gösterecektir.
                            </li>
                            <li>
                                API anahtarınızı kopyalayarak buraya yapıştırın.
                            </li>
                        </ol>

                    </div>
                </div>
            </div>

        </div>
        </div>
    </div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const scrollPos = sessionStorage.getItem("scrollPos");
        if (scrollPos) {
            window.scrollTo(0, parseInt(scrollPos));
            sessionStorage.removeItem("scrollPos");
        }
    });

    window.addEventListener("beforeunload", () => {
        sessionStorage.setItem("scrollPos", window.scrollY);
    });
</script>
</div>
</body>